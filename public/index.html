<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <style>
      .chat {
        display: flex;
        flex-direction: column;
        height: 80vh;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid #ccc;
        margin-bottom: 5px;
      }
      .form {
        display: flex;
      }
      .input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .submit {
        padding: 10px;
        border: 1px solid #ccc;
        background: #eee;
        cursor: pointer;
      }
      .tools {
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .tools label {
        font-family: sans-serif;
      }
      #clearCanvas {
        padding: 5px 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" />
        <button class="submit">Send</button>
      </form>
    </div>

    <canvas
      id="canvas"
      width="600"
      height="600"
      style="border: solid 1px black"
    ></canvas>

    <div class="tools">
      <label for="colorPicker">Color:</label>
      <input type="color" id="colorPicker" value="#000000" />
      <label for="lineWidth">Line Width:</label>
      <input type="range" id="lineWidth" min="1" max="20" value="2" />
      <button id="clearCanvas">Clear All</button>
    </div>
    <script>
      function main() {
        const host = location.origin.replace(/^http/, 'ws');
        const ws = new WebSocket(host + '/ws');
        const myId = self.crypto.randomUUID().substr(0, 8);

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');


        const colorPicker = document.getElementById('colorPicker');
        const lineWidthRange = document.getElementById('lineWidth');
        const clearCanvasBtn = document.getElementById('clearCanvas');

        let drawing = false;
        let currentColor = colorPicker.value;
        let currentLineWidth = lineWidthRange.value;

   

        canvas.addEventListener('mousedown', (e) => {
          drawing = true;
          ctx.strokeStyle = currentColor; 
          ctx.lineWidth = currentLineWidth;   
          ctx.beginPath();
          ctx.moveTo(e.offsetX, e.offsetY);
          sendDrawingEvent(e.offsetX, e.offsetY, 'mousedown');
        });

        canvas.addEventListener('mousemove', (e) => {
          if (drawing) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            sendDrawingEvent(e.offsetX, e.offsetY, 'mousemove');
          }
        });

        canvas.addEventListener('mouseup', (e) => {
          drawing = false;
          sendDrawingEvent(e.offsetX, e.offsetY, 'mouseup');
        });

        canvas.addEventListener('mouseout', (e) => {
          drawing = false;
          sendDrawingEvent(e.offsetX, e.offsetY, 'mouseout');
        });

        colorPicker.addEventListener('change', (e) => {
          currentColor = e.target.value;
        });

       
        lineWidthRange.addEventListener('change', (e) => {
          currentLineWidth = e.target.value;
        });


        clearCanvasBtn.addEventListener('click', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height); 
          ws.send(JSON.stringify({ type: 'paint', control: 'clear' }));
        });


        function sendDrawingEvent(x, y, control) {
          const message = JSON.stringify({
            x,
            y,
            control,
            type: 'paint',
            color: currentColor,
            lineWidth: currentLineWidth,
          });
          ws.send(message);
        }
        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);

          if (msg.type === 'paint') {
            const { x, y, control, color, lineWidth } = msg;

            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;

            if (control === 'mousedown') {
              ctx.beginPath();
              ctx.moveTo(x, y);
            } else if (control === 'mousemove') {
              ctx.lineTo(x, y);
              ctx.stroke();
            } else if (control === 'clear') {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

          }
          if (msg.type === 'chat') {
            const { id, text } = msg;
            const messageList = document.querySelector('.messages');
            const li = document.createElement('li');
            if (id === myId) {
              li.textContent = `(${id})自分:` + text;
            } else {
              li.textContent = id + ': ' + text;
            }
            messageList.appendChild(li);
            messageList.scrollTop = messageList.scrollHeight;
          }
        };

        const form = document.querySelector('.form');
        form.onsubmit = function (e) {
          e.preventDefault();
          const input = document.querySelector('.input');
          const text = input.value;
          if (text) {
            ws.send(JSON.stringify({ id: myId, text, type: 'chat' }));
            input.value = '';
            input.focus();
          }
        };

        ws.onerror = function (error) {
          console.error('WebSocket Error: ', error);
        };
      }

      main();
    </script>
  </body>
</html>